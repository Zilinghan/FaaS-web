<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .row {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      margin-bottom: 20px;
    }
    .chart {
      width: 30%;
      height: 400px;
    }
  </style>
</head>
<body>
  <div id="endpoint-monitor">
    <h1>Endpoint Monitor</h1>
  </div>

  <script>
    var endpointData = {};

    data.forEach(function(endpoint) {
      var rowDiv = document.createElement('div');
      rowDiv.className = "row";

      var nameDiv = document.createElement('div');
      nameDiv.innerHTML = '<h2>' + endpoint.id + '</h2>';
      rowDiv.appendChild(nameDiv);

      var cpuDiv = document.createElement('div');
      cpuDiv.className = "chart";
      cpuDiv.id = "cpu-" + endpoint.id;
      rowDiv.appendChild(cpuDiv);

      var gpuDiv = document.createElement('div');
      gpuDiv.className = "chart";
      gpuDiv.id = "gpu-" + endpoint.id;
      rowDiv.appendChild(gpuDiv);

      var memDiv = document.createElement('div');
      gpuDiv.className = "chart";
      gpuDiv.id = "mem-" + endpoint.id;
      rowDiv.appendChild(memDiv);

      var networkDiv = document.createElement('div');
      networkDiv.className = "chart";
      networkDiv.id = "network-" + endpoint.id;
      rowDiv.appendChild(networkDiv);

      document.getElementById("endpoint-monitor").appendChild(rowDiv);

      Plotly.newPlot(cpuDiv.id, [endpoint.cpu_utilization], {title: 'CPU Utilization', xaxis: {title: 'Time'}, yaxis: {title: 'Utilization (%)'}});
      Plotly.newPlot(gpuDiv.id, [endpoint.gpu_utilization], {title: 'GPU Utilization', xaxis: {title: 'Time'}, yaxis: {title: 'Utilization (%)'}});
      Plotly.newPlot(memDiv.id, [endpoint.memory_utilization], {title: 'Memory Utilization', xaxis: {title: 'Time'}, yaxis: {title: 'Utilization (%)'}});
      Plotly.newPlot(networkDiv.id, [endpoint.bytes_sent, endpoint.bytes_received], {title: 'Network Utilization', xaxis: {title: 'Time'}, yaxis: {title: 'Utilization (%)'}});
    });

    $(document).ready(function(){
        function updateData() {
            $.getJSON('/resources_monitor_data', function(data) {
                for (var endpoint in data) {
                    if (!endpointData.hasOwnProperty(endpoint)) {
                        // Initialize the data array for this endpoint if it's new
                        endpointData[endpoint] = [];
                    }

                    // Add the new datapoint
                    endpointData[endpoint].push({
                        timestamp: new Date(),
                        data: data[endpoint]
                    });

                    // Remove old datapoints if there are more than 100
                    if (endpointData[endpoint].length > 100) {
                        endpointData[endpoint].shift();
                    }
                }

                // Update the page with the new data here, for example:
                updateCharts();
            });
        }

        // Update the data every second
        setInterval(updateData, 1000);
    });
  </script>
</body</html>
