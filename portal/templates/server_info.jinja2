{%extends "base.jinja2"%}

{%block title%}Federation Info{%endblock%}

{%block body%}
  {%include "header.jinja2"%}

  <div class="container">
    <div class="page-header">
      <h1>Federation Information</h1>
    </div>
    
    <h2 class="anchored" data-anchor-id="endpoint-info-title">Endpoint Information</h2>
    <section id="endpoint-information" class="level4">
      <div class="cell" data-execution_count="30">
        <div class="cell-output cell-output-display" data-execution_count="825">
          <div class="container first-container col-sm-12 pull-left">
            <table class="table table-condensed table-striped">
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Organization</th>
                  <th>Email</th>
                  <th>Endpoint Status</th>
                </tr>
              </thead>
              <tbody>
                {%for i in range(client_names|length)%}
                <tr>
                  <td>{{client_names[i]}}</td>
                  <td>{{client_orgs[i]}}</td>
                  <td>
                    <div class="endpoint-info-content">
                      <a href="mailto:{{client_emails[i]}}"><img src="{{url_for('static', filename='img/email.png')}}" role="button" style="cursor: pointer;"/>{{client_emails[i]}}</a>
                    </div>
                  </td>
                  <td>
                    <div class="endpoint-info-content">
                    {% if client_endpoints[i] == '0'%}
                      <img id="info_status_{{client_names[i]}}_{{client_endpoints[i]}}" src="{{url_for('static', filename='img/unset-hex.png')}}" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="Endpoint Status" data-content="The client endpoint is either unset or invalid!" data-placement="left"/>
                    {% else %}
                      <img id="info_status_{{client_names[i]}}_{{client_endpoints[i]}}" src="{{url_for('static', filename='img/loading.gif')}}" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="Endpoint Status" data-content="Checking the status of the client endpoint......" data-placement="left"/>
                    {% endif %}
                    </div>
                  </td>
                </tr>
                {%endfor%}
              </tbody>
            </table>
          </div>
        </div> 
      </div>
    </section>

    <h2 class="anchored" data-anchor-id="exp-info-title">Experiment Information</h2>
    <section id="experiment-information" class="level4">
      <div class="cell" data-execution_count="30">
        <div class="cell-output cell-output-display" data-execution_count="825">
          <div class="container first-container col-sm-12 pull-left">
            <table class="table table-condensed table-striped">
              <thead>
                <tr>
                  <th>Experiment Name</th>
                  <th>Experiment ID</th>
                  <th>Status</th>
                  <th>Config</th>
                  <th>Log</th>
                  <th>Report</th>
                  <th>Tensorboard</th>
                </tr>
              </thead>
              <tbody>
                {%for i in range(task_ids|length)%}
                <tr>
                  <td>{{task_names[i]}}</td>
                  <td>{{task_ids[i]}}</td>
                  <td id="task_{{task_ids[i]}}_status"></td>
                  <td id="task_{{task_ids[i]}}_configfile">
                    <a href="{{url_for('download_file', file_type='configuration', group_id=server_group_id, task_id=task_ids[i])}}">
                      <img src="{{url_for('static', filename='img/config.png')}}" style="width:25px; cursor:pointer;" id="???"/>
                    </a>
                  </td>
                  <td id="task_{{task_id}}_logfile">
                    <a href="{{url_for('download_file', file_type='log', group_id=server_group_id, task_id=task_ids[i])}}">
                      <img src="{{url_for('static', filename='img/log.png')}}" style="width:25px; cursor:pointer;" id="???"/>
                    </a>
                  </td>
                  <td id="task_{{task_id}}_reportfile">
                    <a href="{{url_for('download_file', file_type='report', group_id=server_group_id, task_id=task_ids[i])}}">
                      <img src="{{url_for('static', filename='img/report.png')}}" style="width:25px; cursor:pointer;" id="???"/>
                    </a>
                  </td>
                  <td id="task_{{task_id}}_tbfile">
                    <a href="{{url_for('tensorboard_log_page', server_group_id=server_group_id, task_id=task_ids[i])}}">
                      <img src="{{url_for('static', filename='img/tb.png')}}" style="width:25px; cursor:pointer;" id="???"/>
                    </a>
                  </td>
                </tr>
                {%endfor%}
              </tbody>
            </table>
          </div>
        </div> 
      </div>
    </section>

    <hr class="col-sm-12" style="border-top: 1px solid rgba(128, 128, 128, 0.801) ;" width="100%">

    <div class="form-group col-md-12">
      <button class="btn btn-secondary" onclick="disableBackButton()" id="server-info-page-back-btn">Back</button>
    </div>


    {# <div class="row">
      <div class="col-md-12">
        <div class="endpoint-info-container">
          <div class="endpoint-info-item endpoint-info-header">Client</div>
          <div class="endpoint-info-item endpoint-info-header">Organization</div>
          <div class="endpoint-info-item endpoint-info-header">Email</div>
          <div class="endpoint-info-item endpoint-info-header">Endpoint Status</div>
          {%for i in range(client_names|length)%}
            <div class="endpoint-info-item endpoint-info-content">{{client_names[i]}}</div>
            <div class="endpoint-info-item endpoint-info-content">{{client_orgs[i]}}</div>
            <div class="endpoint-info-item endpoint-info-content">
              <a href="mailto:{{client_emails[i]}}"><img src="{{url_for('static', filename='img/email.png')}}" role="button" style="cursor: pointer;"/>{{client_emails[i]}}</a>
            </div>
            <div class="endpoint-info-item endpoint-info-content">
              {% if client_endpoints[i] == '0'%}
                <img id="info_status_{{client_names[i]}}_{{client_endpoints[i]}}" src="{{url_for('static', filename='img/unset-hex.png')}}" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="Endpoint Status" data-content="The client endpoint is either unset or invalid!" data-placement="left"/>
              {% else %}
                <img id="info_status_{{client_names[i]}}_{{client_endpoints[i]}}" src="{{url_for('static', filename='img/loading.gif')}}" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="Endpoint Status" data-content="Checking the status of the client endpoint......" data-placement="left"/>
              {% endif %}
            </div>
          {%endfor%}
        </div>
        <div class="task-info-container">
          <div class="task-info-item task-info-header">Experiment Name</div>
          <div class="task-info-item task-info-header">Experiment ID</div>
          <div class="task-info-item task-info-header">Status</div>
          <div class="task-info-item task-info-header">Config</div>
          <div class="task-info-item task-info-header">Log</div>
          <div class="task-info-item task-info-header">Report</div>
          <div class="task-info-item task-info-header">Tensorboard</div>
          {% for i in range(task_ids|length)%}
            <div class="task-info-item task-info-content">{{task_names[i]}}</div>
            <div class="task-info-item task-info-content">{{task_ids[i]}}</div>
            <div class="task-info-item task-info-content" id="task_{{task_ids[i]}}_status"></div>
            <div class="task-info-item task-info-content" id="task_{{task_ids[i]}}_configfile">
              <a href="{{url_for('download_file', file_type='configuration', group_id=server_group_id, task_id=task_ids[i])}}">
                <img src="{{url_for('static', filename='img/config.png')}}" style="width:25px; cursor:pointer;" id="???"/>
              </a>
            </div>
            <div class="task-info-item task-info-content" id="task_{{task_id}}_logfile">
              <a href="{{url_for('download_file', file_type='log', group_id=server_group_id, task_id=task_ids[i])}}">
                <img src="{{url_for('static', filename='img/log.png')}}" style="width:25px; cursor:pointer;" id="???"/>
              </a>
            </div>
            <div class="task-info-item task-info-content" id="task_{{task_id}}_reportfile">
              <a href="{{url_for('download_file', file_type='report', group_id=server_group_id, task_id=task_ids[i])}}">
                <img src="{{url_for('static', filename='img/report.png')}}" style="width:25px; cursor:pointer;" id="???"/>
              </a>
            </div>
            <div class="task-info-item task-info-content" id="task_{{task_id}}_tbfile">
              <a href="{{url_for('tensorboard_log_page', server_group_id=server_group_id, task_id=task_ids[i])}}">
                <img src="{{url_for('static', filename='img/tb.png')}}" style="width:25px; cursor:pointer;" id="???"/>
              </a>
            </div>
          {% endfor %}
        </div>
        <div class="form-group">
          <button class="btn btn-secondary" onclick="disableBackButton()" id="server-info-page-back-btn">Back</button>
        </div>
      </div>
    </div> #}

  </div> <!-- container -->

  <script>
    function disableBackButton() {
      document.getElementById('server-info-page-back-btn').disabled = true;
      window.location.href='{{ url_for( 'dashboard') }}';
    }
    $(document).ready(function() {
      $(function () {
        $('[data-toggle="popover"]').popover()
      })
      {# Obtain task infomation #}

      var task_arns = {{task_arns|safe}}
      var sent_arns = {};
      for (var i = 0; i < task_arns.length; i++) {
        sent_arns[i] = task_arns[i];
      }
      $.ajax({
        url: '/task-status',
        method: 'GET',
        data: {task_arns: sent_arns},
        success: function(resp){
          var task_ids = Object.keys(resp);
          console.log(Object.keys(resp));
          for (var i = 0; i < task_ids.length; i++) {
            document.getElementById(`task_${task_ids[i]}_status`).innerHTML = resp[task_ids[i]]['status'];
          }
        }
      })
      
      {# Endpoint Health Status Check #}
      // Obtain the given endpoints to send, and generate an endpoint-name dictionary
      var client_endpoints = {{client_endpoints|safe}};
      var client_names = {{client_names|safe}}
      var sent_data= {};
      var endpoint_name_dict = {}
      for (var i = 0; i < client_endpoints.length; i++){
        if (client_endpoints[i] != '0') {
          sent_data[i] = client_endpoints[i];
          endpoint_name_dict[client_endpoints[i]] = client_names[i];
        }
      }
      {# console.log(endpoint_name_dict)
      console.log(sent_data); #}
      // Send the endpoints for status checking
      $.ajax({
        url: '/status-check',
        method: 'GET',
        data: {endpoints: sent_data},
        contentType: 'multipart/form-data',
        success: function(resp){
          console.log(Object.keys(resp))
          var endpoints = Object.keys(resp);
          for (var i = 0; i < endpoints.length; i++) {
            if (resp[endpoints[i]] == '0') {
              document.getElementById(`info_status_${endpoint_name_dict[endpoints[i]]}_${endpoints[i]}`).src = '{{url_for('static', filename='img/inactive-hex.png')}}';
              document.getElementById(`info_status_${endpoint_name_dict[endpoints[i]]}_${endpoints[i]}`).setAttribute('data-content', 'The client endpoint is inactive or stopped!');
            }
            else if (resp[endpoints[i]] == '1') {
              document.getElementById(`info_status_${endpoint_name_dict[endpoints[i]]}_${endpoints[i]}`).src = '{{url_for('static', filename='img/set-hex.png')}}';
              document.getElementById(`info_status_${endpoint_name_dict[endpoints[i]]}_${endpoints[i]}`).setAttribute('data-content', 'The client endpoint is active with CPU available!'); 
            }
            else if (resp[endpoints[i]] == '2') {
              document.getElementById(`info_status_${endpoint_name_dict[endpoints[i]]}_${endpoints[i]}`).src = '{{url_for('static', filename='img/set-hex.png')}}';
              document.getElementById(`info_status_${endpoint_name_dict[endpoints[i]]}_${endpoints[i]}`).setAttribute('data-content', 'The client endpoint is active with GPU available!');
            }
            else {
              document.getElementById(`info_status_${endpoint_name_dict[endpoints[i]]}_${endpoints[i]}`).src = '{{url_for('static', filename='img/unset-hex.png')}}';
              document.getElementById(`info_status_${endpoint_name_dict[endpoints[i]]}_${endpoints[i]}`).setAttribute('data-content', 'The client endpoint is either unset or invalid!');
            }
          }
        }
      });  
    });
  </script>
{%endblock%}

